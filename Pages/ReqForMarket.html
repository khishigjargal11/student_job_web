<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ê–∂–∏–ª–¥ –æ—Ä–æ—Ö —Ö“Ø—Å—ç–ª—Ç“Ø“Ø–¥</title>
  <link rel="stylesheet" href="../Css/style.css">
  <link rel="stylesheet" href="../Css/components.css">
  <script src="../js/data-manager.js"></script>
  <script src="../data/sampleData.js"></script>
  <script src="../models/Student.js"></script>
  <script src="../models/Company.js"></script>
  <script src="../models/Job.js"></script>
  <script src="../comp/main-header.js" defer></script>
  <script src="../comp/ad-card.js" defer></script>
  <script src="../comp/main-footer.js" defer></script>
  <script src="../comp/student-section.js" defer></script>
  <script src="../comp/back-bar.js" defer></script>
  <script src="../comp/student-popup.js" defer></script>

</head>
<body>
  <!-- Header -->
  <main-header></main-header>
  <!-- Back bar -->
  <back-bar title="–ê–∂–∏–ª–¥ –æ—Ä–æ—Ö —Ö“Ø—Å—ç–ª—Ç“Ø“Ø–¥"></back-bar>
  <!-- Main content -->
  <main class="request-container">
    <!-- Left: job info -->
    <section class="accepted-users-wrapper">
      <div id="job-info">
        <!-- Job info will be loaded dynamically -->
      </div>
      
      <div class="accepted-users-title">
        <h3>–•“Ø–ª—ç—ç–Ω –∞–≤—Å–∞–Ω —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–¥</h3>
      </div>
      
      <div id="accepted-students">
        <!-- Accepted students will be loaded dynamically -->
      </div>
    </section>
    
    <!-- Right: pending applications -->
    <section class="pending-applications">
      <h3>–•“Ø–ª—ç—ç–≥–¥—ç–∂ –±—É–π —Ö“Ø—Å—ç–ª—Ç“Ø“Ø–¥</h3>
      <div id="pending-applications">
        <!-- Pending applications will be loaded dynamically -->
      </div>
    </section>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      DataManager.initializeData();
      loadJobApplications();
    });

    function loadJobApplications() {
      const jobId = sessionStorage.getItem('viewingJobId');
      if (!jobId) {
        document.querySelector('.request-container').innerHTML = '<p>–ê–∂–ª—ã–Ω –º—ç–¥—ç—ç–ª—ç–ª –æ–ª–¥—Å–æ–Ω–≥“Ø–π</p>';
        return;
      }

      const jobData = DataManager.getJobById(jobId);
      if (!jobData) {
        document.querySelector('.request-container').innerHTML = '<p>–ê–∂–ª—ã–Ω –º—ç–¥—ç—ç–ª—ç–ª –æ–ª–¥—Å–æ–Ω–≥“Ø–π</p>';
        return;
      }

      // Convert to Job instance to access methods
      const job = new Job(jobData);

      // Load job info
      loadJobInfo(job);
      
      // Load accepted students
      loadAcceptedStudents(job);
      
      // Load pending applications
      loadPendingApplications(job);
    }

    function loadJobInfo(job) {
      const jobInfoContainer = document.getElementById('job-info');
      
      // Clear existing content to prevent duplicates
      jobInfoContainer.innerHTML = '';
      
      const adCard = document.createElement('ad-card-box');
      adCard.setAttribute('job-id', job.id);
      jobInfoContainer.appendChild(adCard);
    }

    function loadAcceptedStudents(job) {
      const container = document.getElementById('accepted-students');
      
      if (job.acceptedStudents.length === 0) {
        container.innerHTML = '<p class="no-data">–•“Ø–ª—ç—ç–Ω –∞–≤—Å–∞–Ω –æ—é—É—Ç–∞–Ω –±–∞–π—Ö–≥“Ø–π</p>';
        return;
      }

      const studentsData = job.acceptedStudents.map(studentId => {
        const studentData = DataManager.getStudentById(studentId);
        if (!studentData) return null;
        
        // Convert to Student instance to access methods
        const student = new Student(studentData);
        
        return {
          id: student.id,
          name: student.name,
          email: student.email,
          phone: student.phone,
          img: student.profilePicture,
          rating: student.getAverageRating()
        };
      }).filter(Boolean);

      container.innerHTML = studentsData.map(student => `
        <div class="accepted-student-card">
          <img src="${student.img}" alt="${student.name}" class="student-avatar">
          <div class="student-info">
            <h4>${student.name}</h4>
            <p>üìß ${student.email}</p>
            <p>üìû ${student.phone}</p>
            <p>‚≠ê ${student.rating}</p>
          </div>
          <div class="student-actions">
            <button class="remove-btn" onclick="removeAcceptedStudent('${job.id}', '${student.id}')">
              ‚ùå –•–∞—Å–∞—Ö
            </button>
          </div>
        </div>
      `).join('');
    }

    function loadPendingApplications(job) {
      const container = document.getElementById('pending-applications');
      const pendingApps = job.getPendingApplications();
      
      if (pendingApps.length === 0) {
        container.innerHTML = '<p class="no-data">–•“Ø–ª—ç—ç–≥–¥—ç–∂ –±—É–π —Ö“Ø—Å—ç–ª—Ç –±–∞–π—Ö–≥“Ø–π</p>';
        return;
      }

      container.innerHTML = pendingApps.map(app => {
        const studentData = DataManager.getStudentById(app.studentId);
        if (!studentData) return '';

        // Convert to Student instance to access methods
        const student = new Student(studentData);

        return `
          <div class="application-card" data-student-id="${student.id}">
            <img src="${student.profilePicture}" alt="${student.name}" class="student-avatar">
            <div class="student-info">
              <h4>${student.name}</h4>
              <p>üìß ${student.email}</p>
              <p>üìû ${student.phone}</p>
              <p>‚≠ê ${student.getAverageRating()}</p>
              <p class="application-date">–•“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç—Å—ç–Ω: ${new Date(app.appliedAt).toLocaleDateString('mn-MN')}</p>
              ${app.message ? `<p class="application-message">"${app.message}"</p>` : ''}
            </div>
            <div class="application-actions">
              <button class="accept-btn" onclick="handleApplication('${job.id}', '${student.id}', 'accept')">
                –ó”©–≤—à”©”©—Ä”©—Ö
              </button>
              <button class="reject-btn" onclick="handleApplication('${job.id}', '${student.id}', 'reject')">
                –¢–∞—Ç–≥–∞–ª–∑–∞—Ö
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function handleApplication(jobId, studentId, action) {
      const jobData = DataManager.getJobById(jobId);
      if (!jobData) return;

      // Convert to Job instance to access methods
      const job = new Job(jobData);

      let success = false;
      let message = '';

      if (action === 'accept') {
        success = job.acceptStudent(studentId);
        message = success ? '–•“Ø—Å—ç–ª—Ç –∑”©–≤—à”©”©—Ä”©–≥–¥–ª”©”©' : '–û—Ä–æ–Ω —Ç–æ–æ –¥“Ø“Ø—Ä—Å—ç–Ω —ç—Å–≤—ç–ª –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞';
      } else if (action === 'reject') {
        success = job.rejectStudent(studentId);
        message = success ? '–•“Ø—Å—ç–ª—Ç —Ç–∞—Ç–≥–∞–ª–∑–∞–≥–¥–ª–∞–∞' : '–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞';
      }

      if (success) {
        DataManager.saveJob(job.toJSON());
        alert(message);
        loadJobApplications(); // Refresh the display
      } else {
        alert(message);
      }
    }

    function removeAcceptedStudent(jobId, studentId) {
      const confirmRemove = confirm('–¢–∞ —ç–Ω—ç –æ—é—É—Ç–Ω—ã–≥ —Ö“Ø–ª—ç—ç–Ω –∞–≤—Å–∞–Ω –∂–∞–≥—Å–∞–∞–ª—Ç–∞–∞—Å —Ö–∞—Å–∞—Ö—ã–≥ —Ö“Ø—Å—ç–∂ –±–∞–π–Ω–∞ —É—É?\n\n–û—é—É—Ç–∞–Ω –¥–∞—Ö–∏–Ω —Ö“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç–≥—á–¥–∏–π–Ω –∂–∞–≥—Å–∞–∞–ª—Ç–∞–¥ –æ—Ä–Ω–æ.');
      if (!confirmRemove) return;

      const jobData = DataManager.getJobById(jobId);
      if (!jobData) return;

      // Convert to Job instance
      const job = new Job(jobData);

      // Use the Job model method to remove accepted student
      const success = job.removeAcceptedStudent(studentId);

      if (success) {
        // Save updated job
        DataManager.saveJob(job.toJSON());
        alert('–û—é—É—Ç–∞–Ω –∞–º–∂–∏–ª—Ç—Ç–∞–π —Ö–∞—Å–∞–≥–¥–ª–∞–∞. –¢—ç–¥ –¥–∞—Ö–∏–Ω —Ö“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç–≥—á–¥–∏–π–Ω –∂–∞–≥—Å–∞–∞–ª—Ç–∞–¥ –æ—Ä–ª–æ–æ.');
        
        // Refresh the page to show updated data
        loadJobApplications();
      } else {
        alert('–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞');
      }
    }
  </script>
      
  <student-popup></student-popup>
  <main-footer></main-footer>
  <!-- Popup -->

</body>
</html>
